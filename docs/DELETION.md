# 削除処理について

- 基本正常系だけ考える
- トランザクションで DB から削除 → 成功したら S3 から削除
  - S3 からの削除が失敗してゴミが残ることについてはとりあえず考えない
- 例のバグが直ったら関係なくなるが、カスケード削除について考慮したほうが良い
  - つまり、あるエンティティを削除した際に、そのエンティティを参照する他のエンティティが勝手に削除されても大丈夫かについて

例のバグ: https://github.com/prisma/prisma/issues/10861

## 画像の削除

- ある画像はちょうど 1 つのエンティティ（アルバム/アーティスト/プレイリスト）とのみ紐付く
  - よって、エンティティが確認できた時点で削除は安全に行える
  - imageOrder があるため、関連付けは明示的に解除する必要がある
    - この部分は楽観ロックでなんとかなるので、中間テーブルのレコードはカスケード削除してしまっても良い
    - つまりエンティティの imageOrder 取得 → 楽観ロックで imageOrder 更新（この 2 つは実装済み）→ 画像と画像-中間テーブルのレコードを削除で OK
    - これは後から関連づけが追加されることがないために安全
- ImageFile は Image を削除するときにカスケード削除して良いが、S3 からの削除のため事前に取得する必要がある
  - 現状後から追加されることがないのでカスケード削除しても安全ではあるが、できればカスケード削除を禁止したいところ

## トラックの削除

- CoArtist を**カスケード削除**
  - 明示的に削除してもよいが不要
- プレイリストから削除
  - プレイリストにトラックが残っているからといってエラーにしない
  - trackOrder のためこちら側で明示的に削除する必要がある → 画像と同様
  - ただしこちらは多対多であり処理中に新たなプレイリストに対象のトラックが追加される可能性があるためカスケード削除されるとまずい
    （そのプレイリストにおける trackOrder に不整合が生じる）
- TrackFile は画像と同様
- アルバムやアーティストに対して事前に行うことはないが、空になったアルバムとアーティストは画像を含めて自動で削除したい
  - これについてはトランザクションを分けたい

## アルバムの削除

- これ明示的に実装する必要ある？
  - アルバムに含まれるトラックがすべて削除されたら同じ効果が得られることが期待されるので、そういう方向で実装しても良さそう
  - バッチ削除の API があるとなお良い

---

- CoArtist を**カスケード削除**
  - 明示的に削除してもよいが不要
- 画像を削除する
  - ぶら下がった画像を生じさせないようにするため imageOrder の変更の有無を確認してから削除する（楽観ロック）
- 含まれるトラックを全部削除する
- 空になったアーティストを削除する

- 途中でトラックが追加された場合、RESTRICT によって失敗するはず
- 途中で画像が追加された場合、楽観ロック（もしくは例のバグが修正されたら RESTRICT）によって失敗するはず

## プレイリストの削除

- 画像を削除する
- 当然だがトラックは削除しない
  - プレイリストを参照しているのはトラックではなく中間テーブルであるためカスケード削除の影響を受けない
- トラックとの中間テーブルはカスケード削除してしまってよい、取得や確認も不要
  - この場合は trackOrder の変更の有無の確認も不要

## アーティストの削除

- ユーザが手動でやることはまずないはず

- トラックもアルバムもカスケード削除しない → このアーティストのトラックやアルバムがある限り削除できないようにする
- 唯一削除するのは画像

## CoArtist の削除

- CoArtist（中間テーブル）だけ削除、それ以外は特になし

## Source, SourceFile

- S3 からは削除するかもしれないが DB からはとりあえず削除しない
