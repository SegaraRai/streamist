# 削除処理について

- 基本正常系だけ考える
- トランザクションで DB から削除 → 成功したら S3 から削除
  - S3 からの削除が失敗してゴミが残ることについてはとりあえず考えない

例のバグ: https://github.com/prisma/prisma/issues/10861

## 画像の削除

- ある画像はちょうど 1 つのエンティティ（アルバム/アーティスト/プレイリスト）とのみ紐付く
  - よって、エンティティが確認できた時点で削除は安全に行える
  - imageOrder があるため、明示的に削除する必要がある → カスケード削除されると安全でなくなる
    - 楽観ロックを用いて、削除時に更新された場合はエラーとする手もありそう
- ImageFile は Image を削除するときにカスケードして良いが、S3 からの削除のため事前に取得する必要がある

## トラックの削除

- CoArtist を**カスケード削除**
  - 明示的に削除してもよいが不要
- プレイリストから削除
  - プレイリストにトラックが残っているからといってエラーにしない
  - trackOrder のためこちら側で明示的に削除する必要がある → 画像と同様
- TrackFile も画像と同様
- アルバムやアーティストに対して事前に行うことはないが、空になったアルバムとアーティストは画像を含めて自動で削除したい

- 途中でプレイリストに追加された場合、**カスケード削除すると trackOrder に不整合が生じる**（例のバグ）
  - これはトラック側のカラムに情報がないので楽観ロックでは回避できない

## アルバムの削除

- CoArtist を**カスケード削除**
  - 明示的に削除してもよいが不要
- 画像を削除する
  - ぶら下がった画像を生じさせないようにするため imageOrder の変更の有無を確認してから削除する（楽観ロック）
- 含まれるトラックを全部削除する
- 空になったアーティストを削除する

- 途中でトラックが追加された場合、RESTRICT によって失敗するはず
- 途中で画像が追加された場合、楽観ロック（もしくは例のバグが修正されたら RESTRICT）によって失敗するはず

## プレイリストの削除

- 画像を削除する
- 当然だがトラックは削除しない
- トラックとの中間テーブルはカスケード削除してしまってよい、取得や確認も不要
  - この場合は不要だが一応 trackOrder の変更の有無は確認してから削除しておく（楽観ロック）

## アーティストの削除

- ユーザが手動でやることはまずないはず
- トラックもアルバムもカスケード削除しない → このアーティストのトラックやアルバムがある限り削除できないようにする
- 唯一削除するのは画像

## CoArtist の削除

- CoArtist だけ削除、それ以外は特になし

## Source, SourceFile

- S3 からは削除するかもしれないが DB からは削除しない
